






<a href='https://rwserve.readwritetools.com'><img src='./img/rwserve.png' width=80 align=right /></a>

###### Easily build a subscription list

# RWSERVE Nodemailer


<table>
	<tr><th>Abstract</th></tr>
	<tr><td>This plugin responds to properly prepared POSTs by sending a confirmation email to the designated recipient. The code is purposefully over-simplified, and is intended to be a starting point only, for developing a customized subscription list that fits your needs.</td></tr>
</table>

### Motivation

There are many applications where sending an email in response to an HTTP POST
is required. This module is a proof-of-concept plugin that demonstrates one way
to send SMTP messages using the `Nodemailer` module.

#### Customization

This plugin is open-source and may be extended to provide additional features,
such as:

   * Accepting additional form elements such as user profile data or answers to
      survey questions.
   * Customizing the outgoing emails with different messages based on form inputs.
   * Storing email addresses using a file or database.
   * Sending HTML instead of plain text.

### Download

The plugin module is available from <a href='https://www.npmjs.com/package/rwserve-nodemailer'>NPM</a>
. Before proceeding, you should already have `Node.js` and `RWSERVE` configured and
tested.

This module should be installed on your web server in a well-defined place, so
that it can be discovered by `RWSERVE`. The standard place for public domain
plugins is `/srv/rwserve-plugins`.

<pre>
cd /srv/rwserve-plugins
npm install rwserve-nodemailer
</pre>

### Configuration is Everything

Make the software available by declaring it in the `plugins` section of your
configuration file. For detailed instructions on how to do this, refer to the <a href='https://rwserve.readwritetools.com/plugins.blue'>plugins</a>
documentation on the `Read Write Tools HTTP/2 Server` website.

#### TL;DR

<pre>
plugins {
    rwserve-nodemailer {
        location `/srv/rwserve-plugins/node_modules/rwserve-nodemailer/dist/index.js`
        config {
            transport {
                host              127.0.0.1
                port              25
                authMethod        PLAIN
                connectionTimeout 2000
            }
            message-defaults {
                from     welcome.team@example.com
                subject  Welcome
                text     Thank you for signing up today.%0D%0AThis message confirms your request to join our mailing list.%0D%0ATogether we can make it happen!
            }
        }
    }
    router {
        `customer-service/signup`  *methods=POST  *plugin=rwserve-nodemailer
    }    
}
</pre>

### How it works

The plugin receives POST requests originating from a standard `HTML <form> `,
which uses content-type `application/x-www-form-urlencoded`. The request body
should contain one form element, named `recipient`, which contains an email
address.

An email envelope is prepared using the given recipient plus the values for `from`
 `subject`, and `text` which are defined in the `message-defaults` section of the
configuration file.

The email is queued for delivery using SMTP using the values for `host`, `port`, `authMethod`
and `connectionTimeout` defined in the `transport` section of the configuration
file. Values for `authUser` and `authPassword` should be entirely omitted unless
required by your SMTP provider.

When communication with the SMTP server is complete, the last reply code
received from the transport is placed in the special header `nodemailer-smtp-reply`
. A value of `250` generally indicates success, and can be interpreted as "email
was queued for delivery". Other values are generally failures. (Search for "smtp
reply code" to help diagnose those problems.)

The HTTP request/response cycle completes with status code `200` and a response
body with content-type `application/json`. The returned JSON payload contains:

   * `accepted` an array of addresses that were accepted by SMTP
   * `rejected` an array of addresses that were rejected by SMTP
   * `response` the last communication from the SMTP server with reply code
   * `messageId` a unique email identifier generated by SMTP for logging

#### Sample HTML

`<pre>
<form action='https://localhost:7443/customer-service/signup' method=POST>
    <label>Email address <input type=text name=recipient /></label>
    <input type=submit value=Submit />
</form>
</pre>

`#### CURL Test

You can also use CURL to send a request to the plugin like this:

<pre>
curl https://localhost:7443/customer-service/signup -X POST -H content-type:application/x-www-form-urlencoded -H content-length:33 -d "recipient=friendly@mailinator.com"
</pre>

#### Cookbook

A full configuration file with typical settings for a server running on
localhost port 7443, is included in this NPM module at `etc/nodemailer-config`. To
use this configuration file, adjust these variables if they don't match your
server setup:

<pre>
$PLUGIN-PATH='/srv/rwserve-plugins/node_modules/rwserve-nodemailer/dist/index.js'
$PRIVATE-KEY='/etc/pki/tls/private/localhost.key'
$CERTIFICATE='/etc/pki/tls/certs/localhost.crt'
$DOCUMENTS-PATH='/srv/rwserve/configuration-docs'
$RECIPIENT='welcome.team@example.com'
</pre>

#### Deployment

Once you've tested the plugin and are ready to go live, adjust your production
web server's configuration in `/etc/rwserve/rwserve.conf` and restart it using `systemd`
. . .

<pre>
[user@host ~]# systemctl restart rwserve
</pre>

. . . then monitor its request/response activity with `journald`.

<pre>
[user@host ~]# journalctl -u rwserve -ef
</pre>

### Prerequisites

This is a plugin for the **Read Write Tools HTTP/2 Server**, which works on Linux
platforms. Windows, MacOS and BSD are not supported.


<table>
	<tr><th>Software</th> <th>Minimum Version</th></tr>
	<tr><td>Ubuntu</td> <td>16</td></tr>
	<tr><td>Debian</td> <td>9</td></tr>
	<tr><td>Fedora</td> <td>27</td></tr>
	<tr><td>CentOS</td> <td>7.4</td></tr>
	<tr><td>RHEL</td> <td>8</td></tr>
	<tr><td>RWSERVE</td> <td>1.0</td></tr>
	<tr><td>Node.js</td> <td>10.3</td></tr>
</table>

## Review


<table>
	<tr><th>Lessons</th></tr>
	<tr><td>This plugin demonstrates a basic plugin that cooperates with other server software to perform non-HTTP related work. The important patterns to observe are: <ul><li>The SMTP server transport is initialized in the startup method.</li> <li>Once the email message is received by SMTP, control returns to the plugin.</li> <li>The plugin does not wait around to learn whether or not actual delivery of the email occurred.</li> </ul> Find other plugins for the <code>Read Write Tools HTTP/2 Server</code> using <a href='https://www.npmjs.com/search?q=keywords:rwserve'>npm</a> with these keywords: <kbd>rwserve</kbd>, <kbd>http2</kbd>, <kbd>plugins</kbd>. </td></tr>
</table>

<p align=center><a href='https://readwritetools.com'><img src='./img/rwtools.png' width=80 /></a></p>
